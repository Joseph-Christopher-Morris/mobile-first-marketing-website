#!/usr/bin/env node

/**
 * Blog Content Restoration Validation Script
 * 
 * Validates:
 * - Blog posts display original content without AI modifications
 * - Newsletter component renders without prohibited text
 * - Blog layout functionality and responsive behavior
 * 
 * Requirements: 11.1, 11.2
 */

const fs = require('fs');
const path = require('path');

class BlogContentValidator {
  constructor() {
    this.results = {
      originalContent: { passed: 0, failed: 0, details: [] },
      newsletterText: { passed: 0, failed: 0, details: [] },
      layoutFunctionality: { passed: 0, failed: 0, details: [] },
      responsiveBehavior: { passed: 0, failed: 0, details: [] }
    };
  }

  // Validate blog posts contain original content without AI modifications
  validateOriginalContent() {
    console.log('\nüîç Validating blog posts contain original content...');
    
    const blogContentDir = 'src/content/blog';
    const blogFiles = fs.readdirSync(blogContentDir).filter(file => file.endsWith('.ts'));
    
    const aiIndicators = [
      'AI-generated',
      'generated by AI',
      'artificial intelligence',
      'machine learning generated',
      'auto-generated content',
      'Lorem ipsum',
      'placeholder text',
      'sample content',
      'dummy text'
    ];
    
    blogFiles.forEach(file => {
      const filePath = path.join(blogContentDir, file);
      const content = fs.readFileSync(filePath, 'utf8');
      
      let hasAiContent = false;
      const foundIndicators = [];
      
      aiIndicators.forEach(indicator => {
        if (content.toLowerCase().includes(indicator.toLowerCase())) {
          hasAiContent = true;
          foundIndicators.push(indicator);
        }
      });
      
      if (hasAiContent) {
        this.results.originalContent.failed++;
        this.results.originalContent.details.push({
          file,
          issue: `Contains AI indicators: ${foundIndicators.join(', ')}`,
          status: 'FAILED'
        });
      } else {
        this.results.originalContent.passed++;
        this.results.originalContent.details.push({
          file,
          issue: 'Contains original content',
          status: 'PASSED'
        });
      }
    });
    
    // Check for authentic personal content markers
    const authenticMarkers = [
      'Joe from Vivid Auto',
      'my experience',
      'I learned',
      'my campaign',
      'real data',
      'real results',
      'my approach'
    ];
    
    let hasAuthenticContent = false;
    blogFiles.forEach(file => {
      const filePath = path.join(blogContentDir, file);
      const content = fs.readFileSync(filePath, 'utf8');
      
      authenticMarkers.forEach(marker => {
        if (content.toLowerCase().includes(marker.toLowerCase())) {
          hasAuthenticContent = true;
        }
      });
    });
    
    if (hasAuthenticContent) {
      this.results.originalContent.details.push({
        file: 'All blog posts',
        issue: 'Contains authentic personal content markers',
        status: 'PASSED'
      });
    }
  }

  // Validate newsletter component renders without prohibited text
  validateNewsletterText() {
    console.log('\nüìß Validating newsletter component text...');
    
    const newsletterFile = 'src/components/sections/NewsletterSignup.tsx';
    const blogPageFile = 'src/app/blog/page.tsx';
    
    if (!fs.existsSync(newsletterFile)) {
      this.results.newsletterText.failed++;
      this.results.newsletterText.details.push({
        file: newsletterFile,
        issue: 'Newsletter component file not found',
        status: 'FAILED'
      });
      return;
    }
    
    const newsletterContent = fs.readFileSync(newsletterFile, 'utf8');
    const blogPageContent = fs.readFileSync(blogPageFile, 'utf8');
    
    // Check for prohibited text
    const prohibitedText = 'üëâ Join the Newsletter';
    
    if (newsletterContent.includes(prohibitedText)) {
      this.results.newsletterText.failed++;
      this.results.newsletterText.details.push({
        file: newsletterFile,
        issue: `Contains prohibited text: "${prohibitedText}"`,
        status: 'FAILED'
      });
    } else {
      this.results.newsletterText.passed++;
      this.results.newsletterText.details.push({
        file: newsletterFile,
        issue: 'Does not contain prohibited newsletter text',
        status: 'PASSED'
      });
    }
    
    if (blogPageContent.includes(prohibitedText)) {
      this.results.newsletterText.failed++;
      this.results.newsletterText.details.push({
        file: blogPageFile,
        issue: `Contains prohibited text: "${prohibitedText}"`,
        status: 'FAILED'
      });
    } else {
      this.results.newsletterText.passed++;
      this.results.newsletterText.details.push({
        file: blogPageFile,
        issue: 'Does not contain prohibited newsletter text',
        status: 'PASSED'
      });
    }
    
    // Verify newsletter component is still included
    if (blogPageContent.includes('<NewsletterSignup />')) {
      this.results.newsletterText.passed++;
      this.results.newsletterText.details.push({
        file: blogPageFile,
        issue: 'Newsletter component is preserved and included',
        status: 'PASSED'
      });
    } else {
      this.results.newsletterText.failed++;
      this.results.newsletterText.details.push({
        file: blogPageFile,
        issue: 'Newsletter component is missing',
        status: 'FAILED'
      });
    }
  }

  // Validate blog layout functionality
  validateLayoutFunctionality() {
    console.log('\nüé® Validating blog layout functionality...');
    
    const blogPageFile = 'src/app/blog/page.tsx';
    const blogPostFile = 'src/app/blog/[slug]/page.tsx';
    
    const requiredElements = [
      { pattern: /getAllBlogPosts/, description: 'Blog posts loading function' },
      { pattern: /getFeaturedPosts/, description: 'Featured posts function' },
      { pattern: /href=.*\/blog\//, description: 'Blog post links' },
      { pattern: /Image[\s\S]*?src[\s\S]*?alt/, description: 'Blog post images with alt text' },
      { pattern: /className.*grid/, description: 'Grid layout for blog posts' },
      { pattern: /NewsletterSignup/, description: 'Newsletter component inclusion' }
    ];
    
    [blogPageFile, blogPostFile].forEach(file => {
      if (!fs.existsSync(file)) {
        this.results.layoutFunctionality.failed++;
        this.results.layoutFunctionality.details.push({
          file,
          issue: 'Blog layout file not found',
          status: 'FAILED'
        });
        return;
      }
      
      const content = fs.readFileSync(file, 'utf8');
      
      requiredElements.forEach(element => {
        if (element.pattern.test(content)) {
          this.results.layoutFunctionality.passed++;
          this.results.layoutFunctionality.details.push({
            file,
            issue: `${element.description} is present`,
            status: 'PASSED'
          });
        } else {
          this.results.layoutFunctionality.failed++;
          this.results.layoutFunctionality.details.push({
            file,
            issue: `${element.description} is missing`,
            status: 'FAILED'
          });
        }
      });
    });
  }

  // Validate responsive behavior
  validateResponsiveBehavior() {
    console.log('\nüì± Validating responsive behavior...');
    
    const blogPageFile = 'src/app/blog/page.tsx';
    const blogPostFile = 'src/app/blog/[slug]/page.tsx';
    
    const responsivePatterns = [
      { pattern: /md:/, description: 'Medium screen breakpoints' },
      { pattern: /lg:/, description: 'Large screen breakpoints' },
      { pattern: /sm:/, description: 'Small screen breakpoints' },
      { pattern: /grid.*md:grid-cols/, description: 'Responsive grid columns' },
      { pattern: /text-.*md:text-/, description: 'Responsive text sizing' },
      { pattern: /py-.*md:py-/, description: 'Responsive padding' }
    ];
    
    [blogPageFile, blogPostFile].forEach(file => {
      const content = fs.readFileSync(file, 'utf8');
      
      responsivePatterns.forEach(pattern => {
        if (pattern.pattern.test(content)) {
          this.results.responsiveBehavior.passed++;
          this.results.responsiveBehavior.details.push({
            file: path.basename(file),
            issue: `${pattern.description} implemented`,
            status: 'PASSED'
          });
        } else {
          this.results.responsiveBehavior.failed++;
          this.results.responsiveBehavior.details.push({
            file: path.basename(file),
            issue: `${pattern.description} missing`,
            status: 'FAILED'
          });
        }
      });
    });
  }

  // Generate validation report
  generateReport() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const reportData = {
      timestamp,
      summary: {
        originalContent: {
          total: this.results.originalContent.passed + this.results.originalContent.failed,
          passed: this.results.originalContent.passed,
          failed: this.results.originalContent.failed,
          passRate: `${Math.round((this.results.originalContent.passed / (this.results.originalContent.passed + this.results.originalContent.failed)) * 100)}%`
        },
        newsletterText: {
          total: this.results.newsletterText.passed + this.results.newsletterText.failed,
          passed: this.results.newsletterText.passed,
          failed: this.results.newsletterText.failed,
          passRate: `${Math.round((this.results.newsletterText.passed / (this.results.newsletterText.passed + this.results.newsletterText.failed)) * 100)}%`
        },
        layoutFunctionality: {
          total: this.results.layoutFunctionality.passed + this.results.layoutFunctionality.failed,
          passed: this.results.layoutFunctionality.passed,
          failed: this.results.layoutFunctionality.failed,
          passRate: `${Math.round((this.results.layoutFunctionality.passed / (this.results.layoutFunctionality.passed + this.results.layoutFunctionality.failed)) * 100)}%`
        },
        responsiveBehavior: {
          total: this.results.responsiveBehavior.passed + this.results.responsiveBehavior.failed,
          passed: this.results.responsiveBehavior.passed,
          failed: this.results.responsiveBehavior.failed,
          passRate: `${Math.round((this.results.responsiveBehavior.passed / (this.results.responsiveBehavior.passed + this.results.responsiveBehavior.failed)) * 100)}%`
        }
      },
      details: this.results,
      requirements: {
        '11.1': 'Blog posts display original content without AI modifications',
        '11.2': 'Newsletter component renders without prohibited text'
      }
    };

    // Save detailed report
    const reportFile = `blog-content-validation-report-${Date.now()}.json`;
    fs.writeFileSync(reportFile, JSON.stringify(reportData, null, 2));

    // Generate summary
    const summaryFile = `blog-content-validation-summary-${Date.now()}.md`;
    const summaryContent = this.generateSummaryMarkdown(reportData);
    fs.writeFileSync(summaryFile, summaryContent);

    return { reportFile, summaryFile, data: reportData };
  }

  generateSummaryMarkdown(data) {
    return `# Blog Content Validation Summary

**Generated:** ${data.timestamp}

## Overall Results

| Category | Total | Passed | Failed | Pass Rate |
|----------|-------|--------|--------|-----------|
| Original Content | ${data.summary.originalContent.total} | ${data.summary.originalContent.passed} | ${data.summary.originalContent.failed} | ${data.summary.originalContent.passRate} |
| Newsletter Text | ${data.summary.newsletterText.total} | ${data.summary.newsletterText.passed} | ${data.summary.newsletterText.failed} | ${data.summary.newsletterText.passRate} |
| Layout Functionality | ${data.summary.layoutFunctionality.total} | ${data.summary.layoutFunctionality.passed} | ${data.summary.layoutFunctionality.failed} | ${data.summary.layoutFunctionality.passRate} |
| Responsive Behavior | ${data.summary.responsiveBehavior.total} | ${data.summary.responsiveBehavior.passed} | ${data.summary.responsiveBehavior.failed} | ${data.summary.responsiveBehavior.passRate} |

## Requirements Validation

- **Requirement 11.1:** ${data.summary.originalContent.failed === 0 ? '‚úÖ PASSED' : '‚ùå FAILED'} - Blog posts display original content without AI modifications
- **Requirement 11.2:** ${data.summary.newsletterText.failed === 0 ? '‚úÖ PASSED' : '‚ùå FAILED'} - Newsletter component renders without prohibited text

## Key Findings

### Original Content Validation
${data.details.originalContent.details.map(detail => `- ${detail.status === 'PASSED' ? '‚úÖ' : '‚ùå'} ${detail.file}: ${detail.issue}`).join('\n')}

### Newsletter Text Validation
${data.details.newsletterText.details.map(detail => `- ${detail.status === 'PASSED' ? '‚úÖ' : '‚ùå'} ${detail.file}: ${detail.issue}`).join('\n')}

### Layout Functionality
${data.details.layoutFunctionality.details.slice(0, 5).map(detail => `- ${detail.status === 'PASSED' ? '‚úÖ' : '‚ùå'} ${detail.file}: ${detail.issue}`).join('\n')}

### Responsive Behavior
${data.details.responsiveBehavior.details.slice(0, 5).map(detail => `- ${detail.status === 'PASSED' ? '‚úÖ' : '‚ùå'} ${detail.file}: ${detail.issue}`).join('\n')}

## Recommendations

${data.summary.originalContent.failed > 0 ? '- Review blog content files for AI-generated content indicators' : ''}
${data.summary.newsletterText.failed > 0 ? '- Remove prohibited newsletter text and ensure component is preserved' : ''}
${data.summary.layoutFunctionality.failed > 0 ? '- Fix missing blog layout functionality elements' : ''}
${data.summary.responsiveBehavior.failed > 0 ? '- Implement missing responsive design patterns' : ''}

---
*Generated by Blog Content Validation Script*
`;
  }

  async run() {
    console.log('üöÄ Starting Blog Content Restoration Validation...');
    console.log('üìã Task 8.1: Validate blog content restoration');
    console.log('üìã Requirements: 11.1, 11.2');
    
    this.validateOriginalContent();
    this.validateNewsletterText();
    this.validateLayoutFunctionality();
    this.validateResponsiveBehavior();
    
    const report = this.generateReport();
    
    console.log('\nüìä Validation Complete!');
    console.log(`üìÑ Detailed report: ${report.reportFile}`);
    console.log(`üìù Summary report: ${report.summaryFile}`);
    
    // Display summary in console
    const totalTests = Object.values(report.data.summary).reduce((sum, category) => sum + category.total, 0);
    const totalPassed = Object.values(report.data.summary).reduce((sum, category) => sum + category.passed, 0);
    const totalFailed = Object.values(report.data.summary).reduce((sum, category) => sum + category.failed, 0);
    const overallPassRate = Math.round((totalPassed / totalTests) * 100);
    
    console.log(`\nüìà Overall Results: ${totalPassed}/${totalTests} tests passed (${overallPassRate}%)`);
    
    if (totalFailed === 0) {
      console.log('‚úÖ All blog content restoration requirements validated successfully!');
      return true;
    } else {
      console.log(`‚ùå ${totalFailed} validation issues found. Check reports for details.`);
      return false;
    }
  }
}

// Run validation if called directly
if (require.main === module) {
  const validator = new BlogContentValidator();
  validator.run().then(success => {
    process.exit(success ? 0 : 1);
  }).catch(error => {
    console.error('‚ùå Validation failed:', error);
    process.exit(1);
  });
}

module.exports = BlogContentValidator;